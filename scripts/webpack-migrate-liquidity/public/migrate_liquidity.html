<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <base href=".">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <title>Hello, world!</title>
</head>
<body onload="document.body.style.display='none';">
<div class="container">
    <h1 style="text-align: center">Migrate liquidity</h1>
    <form id="formID">
        <div class="form-group">
            <label for="pair_from">From a pair address</label>
            <select class="form-select" id="pair_from" aria-label="Default select example" onchange="getPairPool()">
                <option selected>Open this select menu</option>
            </select>
        </div>
        <div class="form-group">
            <label for="poolID">Allowed pool</label>
            <input type="text" value="0" id="poolID" readonly>
        </div>
        <div class="form-group">
            <label for="amount">Amount</label>
            <input type="number" class="form-control" id="amount" placeholder="Enter an amount of migrate...">
        </div>
        <button type="button" class="btn btn-primary" onclick="submitMigration()">Submit</button>

    </form>
</div>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<script src="./bundle-main.js"></script>
<script type="text/javascript">
    const chainID="bombay-12"
    const nodeURL ="https://bombay-lcd.terra.dev"
    const walletMnemonic="quality vacuum heart guard buzz spike sight swarm shove special gym robust assume sudden deposit grid alcohol choice devote leader tilt noodle tide penalty"
    const terraSwapFactoryAddr = "terra18qpjm4zkvqnpjpw0zn0tdr8gdzvt8au35v45xf"

    let cl = EntryPoint.newClient(nodeURL, chainID, walletMnemonic);

    async function getAllPairs() {
        let totalPairs = []
        let response = await EntryPoint.pairs(cl, terraSwapFactoryAddr, {"pairs": {"limit": 30}});
        totalPairs.push(...response.pairs);

        do {
            response = await EntryPoint.pairs(cl, terraSwapFactoryAddr, {"pairs": {"limit": 30, "start_after": totalPairs[totalPairs.length - 1].asset_infos}});
            totalPairs.push(...response.pairs);
        } while ( response.pairs.length > 0);

        return totalPairs;
    }

    async function getPairPool() {
        let pairFrom = document.getElementById("pair_from").value;
        let poolElement = document.getElementById("poolID");

        let response = await EntryPoint.pairPool(cl, pairFrom, {"pool": {}});
        console.log("pool:", response);
        poolElement.value = response;
    }

    async function getType() {
        let pairs = await getAllPairs();
        console.log("pairsList: ", pairs);

        const sb = document.querySelector('#pair_from');
        for (let i=0; i<pairs.length; i++) {
            let optionName = [];
            try {
                for (let j=0; j<pairs[i].asset_infos.length; j++){
                    if (pairs[i].asset_infos[j].hasOwnProperty("token")) {
                        let tokenInfo = await EntryPoint.tokenInfo(cl, pairs[i].asset_infos[j].token.contract_addr, {"token_info": {}});
                        optionName.push(tokenInfo.name);
                    } else {
                        optionName.push(pairs[i].asset_infos[j].native_token.denom);
                    }
                }
                const option = new Option(optionName[0] + " -- " + optionName[1], pairs[i].contract_addr);
                sb.appendChild(option);
            } catch (e) {}
        }
    }
    window.onload = getType();

    async function submitMigration(){
        let pairFrom = document.getElementById("pair_from").value;
        let amount = document.getElementById("amount").value;
        console.log("Pair from: ", pairFrom);
        console.log("amount: ", amount);

        let assetsInf = await EntryPoint.assetsInfo(cl, pairFrom, {"pair": {}});
        console.log("assetInf: ", assetsInf);

        let pairTo = "";
        try {
            let response = await EntryPoint.isExistsPair(cl, terraSwapFactoryAddr, assetsInf);
            console.log("exists pair: ", response);
            pairTo = response.contract_addr;
        } catch (e) {}

        if (pairTo === "") {
           if (!confirm('Are you sure you want to create a new pair?')) {
               console.log('Operation was canceled.');
               return
           }

           try {
               await EntryPoint.createPair(cl, terraSwapFactoryAddr, assetsInf);
               let response = await EntryPoint.isExistsPair(cl, terraSwapFactoryAddr, assetsInf);
               console.log("exists pair: ", response);
               pairTo = response.contract_addr;
           } catch (e){}
        }

        try {
            let response = await EntryPoint.migrateLiquidity(cl, pairFrom, pairTo, amount);
            console.log("response: ", response)
        } catch (e){
            console.log(e);
        }
    }
</script>
</body>
</html>